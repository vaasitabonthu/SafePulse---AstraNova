<!DOCTYPE html>
<html>
<head>
<title>SafePulse - Supervisor Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="styles.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* Chart sizing overrides */

.chart-small {
    width: 250px !important;
    height: 250px !important;
    margin: 0 auto;
}

.chart-large {
    width: 100% !important;
    height: 280px !important;
}
</style>

</head>

<body>

<div class="header">

<button class="logout-btn" onclick="logout()">Logout</button>

<button class="mode-btn" onclick="toggleMode()" id="modeIcon">
<i class="fas fa-moon"></i>
</button>

<h1 id="greeting"></h1>

<p class="intro-text">
SafePulse provides real-time insights into worker safety,
environmental conditions, and risk distribution across your
construction site. Monitor high-risk cases and take proactive action.
</p>

</div>

<div class="section">

<div class="grid">

<div class="card">
<h3>Male vs Female Workers</h3>
<canvas id="genderChart" class="chart-small"></canvas>
</div>

<div class="card">
<h3>Risk Level Distribution</h3>
<canvas id="riskPie" class="chart-small"></canvas>
</div>

</div>

<div class="card">
<h3>All Workers Overview</h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Gender</th>
<th>Site Area</th>
<th>Hours</th>
<th>Risk Score</th>
<th>Risk Level</th>
</tr>
</thead>
<tbody id="workerTable"></tbody>
</table>
</div>

<div class="card">
<h3>Risk Score Comparison</h3>
<canvas id="riskBar" class="chart-large"></canvas>
</div>

<div class="alert-box" id="alertSummary"></div>

</div>

<footer>
Â© 2026 SafePulse | Supervisor Control Panel
</footer>

<script>
const currentUser = JSON.parse(localStorage.getItem("currentUser"));

if (!currentUser || currentUser.role !== "supervisor") {
    window.location.href = "index.html";
}

document.addEventListener("DOMContentLoaded", function(){

document.getElementById("greeting").innerText =
"Hello " + (currentUser.name || "Supervisor") + " ðŸ‘¨â€ðŸ’¼";

/* FETCH REPORTS FROM BACKEND */
fetch("http://localhost:5000/reports")
.then(res => res.json())
.then(workers => {

    const table = document.getElementById("workerTable");
    table.innerHTML = "";

    if(workers.length === 0){
        document.getElementById("alertSummary").innerText =
        "No worker reports available.";
        return;
    }

    /* ---- TABLE POPULATION ---- */
    workers.forEach(w => {

        let levelClass = "";
        if(w.riskScore >= 70) levelClass = "high";
        else if(w.riskScore >= 40) levelClass = "medium";
        else levelClass = "low";

        table.innerHTML += `
        <tr>
            <td>${w.name}</td>
            <td>${w.gender}</td>
            <td>${w.siteArea}</td>
            <td>${w.hours}</td>
            <td>${w.riskScore}</td>
            <td class="${levelClass}">${w.riskLevel}</td>
        </tr>
        `;
    });

    /* ---- CALCULATIONS ---- */
    let male = workers.filter(w => w.gender==="Male").length;
    let female = workers.filter(w => w.gender==="Female").length;

    let high = workers.filter(w => w.riskScore >= 70).length;
    let medium = workers.filter(w => w.riskScore >=40 && w.riskScore <70).length;
    let low = workers.filter(w => w.riskScore <40).length;

    function percent(v){
        return ((v/workers.length)*100).toFixed(1)+"%";
    }

    /* ---- GENDER PIE ---- */
    new Chart(document.getElementById("genderChart"), {
        type:"pie",
        data:{
            labels:[
                `Male (${percent(male)})`,
                `Female (${percent(female)})`
            ],
            datasets:[{
                data:[male,female],
                backgroundColor:["#3E6985","#A6BED1"]
            }]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false
        }
    });

    /* ---- RISK PIE ---- */
    new Chart(document.getElementById("riskPie"), {
        type:"pie",
        data:{
            labels:[
                `High (${percent(high)})`,
                `Medium (${percent(medium)})`,
                `Low (${percent(low)})`
            ],
            datasets:[{
                data:[high,medium,low],
                backgroundColor:["red","orange","green"]
            }]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false
        }
    });

    /* ---- BAR CHART ---- */
    new Chart(document.getElementById("riskBar"), {
        type:"bar",
        data:{
            labels:workers.map(w=>w.name),
            datasets:[{
                label:"Risk Score",
                data:workers.map(w=>w.riskScore),
                backgroundColor:"#3E6985"
            }]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            scales:{
                y:{beginAtZero:true,max:100}
            }
        }
    });

    /* ---- ALERT SUMMARY ---- */
    let avgRisk = workers.reduce((sum,w)=>sum+w.riskScore,0)/workers.length;
    let alertBox = document.getElementById("alertSummary");

    if(avgRisk<40){
        alertBox.style.background="green";
        alertBox.innerText="Overall Site Status: SAFE";
    }
    else if(avgRisk<70){
        alertBox.style.background="orange";
        alertBox.innerText="Overall Site Status: MODERATE RISK - Monitor Closely";
    }
    else{
        alertBox.style.background="red";
        alertBox.innerText="Overall Site Status: HIGH RISK - Immediate Action Required";
    }

})
.catch(error => {
    console.log("Error fetching reports:", error);
});

});

/* Toggle */
function toggleMode(){
document.body.classList.toggle("light-mode");
const icon=document.querySelector("#modeIcon i");
icon.classList.toggle("fa-moon");
icon.classList.toggle("fa-sun");
}

/* Logout */
function logout(){
localStorage.removeItem("currentUser");
window.location.href="index.html";
}
</script>

</body>
</html>